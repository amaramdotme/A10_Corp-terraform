name: Foundation Destroy

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "destroy-foundation" to confirm'
        required: true
        type: string

permissions:
  id-token: write
  contents: read
  actions: read

jobs:
  validate-confirmation:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "destroy-foundation" ]; then
            echo "‚ùå Confirmation failed. You must type 'destroy-foundation' to proceed."
            exit 1
          fi
          echo "‚úÖ Confirmation validated"

  check-prerequisites:
    name: Check Prerequisites
    runs-on: ubuntu-latest
    needs: validate-confirmation
    outputs:
      foundation-jobs-running: ${{ steps.check-foundation.outputs.jobs-running }}
      workloads-state-empty: ${{ steps.check-workloads-state.outputs.state-empty }}

    steps:
      - name: Check for Active Foundation Workflows
        id: check-foundation
        run: |
          ACTIVE_RUNS=$(gh run list \
            --workflow=foundation-deploy.yml \
            --status=in_progress \
            --json status \
            --jq 'length')

          echo "Active foundation workflows: $ACTIVE_RUNS"

          if [ "$ACTIVE_RUNS" -gt 0 ]; then
            echo "jobs-running=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Foundation deployment is currently running. Please wait for it to complete."
            exit 1
          else
            echo "jobs-running=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Check Workloads State (Dev)
        id: check-workloads-state-dev
        run: |
          terraform init -backend-config="environments/backend-dev.hcl"
          DEV_COUNT=$(terraform state list 2>/dev/null | wc -l)
          echo "Dev environment resources: $DEV_COUNT"
          echo "dev_count=$DEV_COUNT" >> $GITHUB_OUTPUT
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        continue-on-error: true

      - name: Check Workloads State (Stage)
        id: check-workloads-state-stage
        run: |
          terraform init -reconfigure -backend-config="environments/backend-stage.hcl"
          STAGE_COUNT=$(terraform state list 2>/dev/null | wc -l)
          echo "Stage environment resources: $STAGE_COUNT"
          echo "stage_count=$STAGE_COUNT" >> $GITHUB_OUTPUT
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        continue-on-error: true

      - name: Check Workloads State (Prod)
        id: check-workloads-state-prod
        run: |
          terraform init -reconfigure -backend-config="environments/backend-prod.hcl"
          PROD_COUNT=$(terraform state list 2>/dev/null | wc -l)
          echo "Prod environment resources: $PROD_COUNT"
          echo "prod_count=$PROD_COUNT" >> $GITHUB_OUTPUT
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        continue-on-error: true

      - name: Validate All Workloads Empty
        id: check-workloads-state
        run: |
          DEV_COUNT="${{ steps.check-workloads-state-dev.outputs.dev_count }}"
          STAGE_COUNT="${{ steps.check-workloads-state-stage.outputs.stage_count }}"
          PROD_COUNT="${{ steps.check-workloads-state-prod.outputs.prod_count }}"

          # Default to 0 if empty
          DEV_COUNT=${DEV_COUNT:-0}
          STAGE_COUNT=${STAGE_COUNT:-0}
          PROD_COUNT=${PROD_COUNT:-0}

          TOTAL_COUNT=$((DEV_COUNT + STAGE_COUNT + PROD_COUNT))

          echo "Total workloads resources across all environments: $TOTAL_COUNT"
          echo "  - Dev: $DEV_COUNT"
          echo "  - Stage: $STAGE_COUNT"
          echo "  - Prod: $PROD_COUNT"

          if [ "$TOTAL_COUNT" -gt 0 ]; then
            echo "state-empty=false" >> $GITHUB_OUTPUT
            echo "‚ùå ERROR: Workloads still exist in one or more environments."
            echo "You must destroy all workloads before destroying foundation."
            exit 1
          else
            echo "state-empty=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All workloads environments are empty"
          fi

  terraform-destroy-plan:
    name: Terraform Destroy Plan (Foundation)
    runs-on: ubuntu-latest
    needs: check-prerequisites
    environment: global

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: terraform init -backend-config="environments/backend.hcl"
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Destroy Plan
        run: terraform plan -destroy -out=foundation-destroy.tfplan
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Upload Destroy Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: foundation-destroy-tfplan
          path: foundation/foundation-destroy.tfplan
          retention-days: 7

      - name: Show Plan Summary
        run: |
          echo "‚ö†Ô∏è **DESTROY PLAN GENERATED FOR FOUNDATION**"
          echo "This will destroy all Management Groups and Subscription Associations."
          echo "Review the plan artifact carefully before approving the apply step."
          terraform show foundation-destroy.tfplan
        working-directory: ./foundation

  terraform-destroy-apply:
    name: Terraform Destroy Apply (Foundation)
    runs-on: ubuntu-latest
    needs: terraform-destroy-plan
    environment:
      name: global
      url: https://portal.azure.com/#view/Microsoft_Azure_ManagementGroups/ManagementGroupBrowseBlade

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Download Destroy Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: foundation-destroy-tfplan
          path: foundation/

      - name: Terraform Init
        run: terraform init -backend-config="environments/backend.hcl"
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Destroy Apply
        run: |
          echo "üî• Destroying foundation infrastructure (Management Groups)..."
          terraform apply -auto-approve foundation-destroy.tfplan
          echo "‚úÖ Destroy completed"
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
