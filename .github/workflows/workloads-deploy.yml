name: Workloads CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'workloads/**'
      - 'modules/workloads/**'
      - '.github/workflows/workloads-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'workloads/**'
      - 'modules/workloads/**'
      - '.github/workflows/workloads-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}

    steps:
      - name: Determine Environment
        id: determine-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  check-prerequisites:
    name: Check Prerequisites
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    outputs:
      foundation-jobs-running: ${{ steps.check-foundation.outputs.jobs-running }}
      foundation-state-ok: ${{ steps.check-foundation-state.outputs.state-ok }}

    steps:
      - name: Check for Active Foundation Workflows
        id: check-foundation
        run: |
          ACTIVE_RUNS=$(gh run list \
            --workflow=foundation-deploy.yml \
            --status=in_progress \
            --json status \
            --jq 'length')

          echo "Active foundation workflows: $ACTIVE_RUNS"

          if [ "$ACTIVE_RUNS" -gt 0 ]; then
            echo "jobs-running=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Foundation deployment is currently running. Please wait for it to complete."
            exit 1
          else
            echo "jobs-running=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Check Foundation State
        id: check-foundation-state
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_VAR_root_resource_group_name }}" \
            -backend-config="storage_account_name=${{ vars.TF_VAR_root_storage_account_name }}" \
            -backend-config="environments/backend.hcl"

          # Check if state exists and has resources
          RESOURCE_COUNT=$(terraform state list 2>/dev/null | wc -l)

          echo "Foundation resources in state: $RESOURCE_COUNT"

          if [ "$RESOURCE_COUNT" -lt 3 ]; then
            echo "state-ok=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ WARNING: Foundation state appears incomplete (expected at least 3 resources, found $RESOURCE_COUNT)"
            echo "::warning::Foundation not fully deployed. This is expected during initial bootstrap."

            # Only fail on main branch (when actually deploying), allow PRs to proceed
            if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
              echo "::error::Cannot deploy workloads without foundation. Deploy foundation first."
              exit 1
            else
              echo "::notice::Allowing PR to proceed for planning purposes (non-blocking check)"
            fi
          else
            echo "state-ok=true" >> $GITHUB_OUTPUT
            echo "âœ… Foundation state looks good ($RESOURCE_COUNT resources)"
          fi
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          TF_VAR_root_resource_group_name: ${{ vars.TF_VAR_root_resource_group_name }}
          TF_VAR_root_key_vault_name: ${{ vars.TF_VAR_root_key_vault_name }}
          TF_VAR_root_storage_account_name: ${{ vars.TF_VAR_root_storage_account_name }}

  terraform-plan:
    name: Terraform Plan (Workloads)
    runs-on: ubuntu-latest
    needs: [determine-environment, check-prerequisites]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ./workloads
        continue-on-error: true

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_VAR_root_resource_group_name }}" \
            -backend-config="storage_account_name=${{ vars.TF_VAR_root_storage_account_name }}" \
            -backend-config="environments/backend-${{ needs.determine-environment.outputs.environment }}.hcl"
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Validate
        run: terraform validate
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          TF_VAR_root_resource_group_name: ${{ vars.TF_VAR_root_resource_group_name }}
          TF_VAR_root_key_vault_name: ${{ vars.TF_VAR_root_key_vault_name }}
          TF_VAR_root_storage_account_name: ${{ vars.TF_VAR_root_storage_account_name }}

      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file="environments/${{ needs.determine-environment.outputs.environment }}.tfvars" \
            -out=${{ needs.determine-environment.outputs.environment }}.tfplan
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          TF_VAR_root_resource_group_name: ${{ vars.TF_VAR_root_resource_group_name }}
          TF_VAR_root_key_vault_name: ${{ vars.TF_VAR_root_key_vault_name }}
          TF_VAR_root_storage_account_name: ${{ vars.TF_VAR_root_storage_account_name }}

      - name: Generate Human-Readable Plan
        run: terraform show -no-color ${{ needs.determine-environment.outputs.environment }}.tfplan > ${{ needs.determine-environment.outputs.environment }}-plan.txt
        working-directory: ./workloads

      - name: Upload Plan to Azure Storage (Audit Trail)
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          ENV="${{ needs.determine-environment.outputs.environment }}"
          BLOB_NAME="plans/workloads-${ENV}-${TIMESTAMP}-${{ github.run_number }}.txt"
          az storage blob upload \
            --account-name ${{ vars.TF_VAR_root_storage_account_name }} \
            --container-name "workloads-${ENV}" \
            --name "$BLOB_NAME" \
            --file "${ENV}-plan.txt" \
            --auth-mode login
          echo "âœ… Plan uploaded to Azure Storage: $BLOB_NAME"
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Upload Plan Artifact (For Apply Job)
        uses: actions/upload-artifact@v4
        with:
          name: workloads-${{ needs.determine-environment.outputs.environment }}-tfplan
          path: workloads/${{ needs.determine-environment.outputs.environment }}.tfplan
          retention-days: 7

      - name: Generate Plan Summary for PR
        if: github.event_name == 'pull_request'
        id: plan-summary
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"
          # Extract summary (first 50 lines of plan)
          SUMMARY=$(terraform show -no-color ${ENV}.tfplan | head -50)
          TOTAL_LINES=$(terraform show -no-color ${ENV}.tfplan | wc -l)

          # Save for PR comment
          echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_OUTPUT
        working-directory: ./workloads

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PLAN_SUMMARY: ${{ steps.plan-summary.outputs.SUMMARY }}
          TOTAL_LINES: ${{ steps.plan-summary.outputs.TOTAL_LINES }}
          ENVIRONMENT: ${{ needs.determine-environment.outputs.environment }}
          BLOB_PATH: plans/workloads-${{ needs.determine-environment.outputs.environment }}-TIMESTAMP-${{ github.run_number }}.txt
        with:
          script: |
            const summary = process.env.PLAN_SUMMARY;
            const totalLines = process.env.TOTAL_LINES;
            const env = process.env.ENVIRONMENT;
            const blobPath = process.env.BLOB_PATH;
            const containerName = `workloads-${env}`;
            const azureStorageUrl = `https://portal.azure.com/#view/Microsoft_Azure_Storage/BlobPropertiesBladeV2/storageAccountId/%2Fsubscriptions%2F${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}%2FresourceGroups%2Frg-root-iac%2Fproviders%2FMicrosoft.Storage%2FstorageAccounts%2Fstorerootblob/path/${containerName}%2F${blobPath}`;

            const body = `## âœ… Workloads Terraform Plan (${env})

            **Status**: Plan generated successfully
            **Environment**: ${env}
            **Total changes**: ${totalLines} lines

            ### Plan Preview (first 50 lines)
            \`\`\`terraform
            ${summary}
            ${totalLines > 50 ? '\n... (truncated, see full plan in Azure Storage)\n' : ''}
            \`\`\`

            ### ðŸ“‹ Full Plan Available
            - **Azure Storage**: [View full plan in Azure Portal](${azureStorageUrl})
            - **Container**: \`storerootblob/${containerName}\`
            - **Path**: \`${blobPath}\`

            ### Next Steps
            1. Review the plan above or download from Azure Storage
            2. Approve this workflow run to proceed with apply
            3. The exact plan shown will be applied (no changes)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

  terraform-apply:
    name: Terraform Apply (Workloads)
    runs-on: ubuntu-latest
    needs: [determine-environment, check-prerequisites, terraform-plan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: https://portal.azure.com/#browse/resourcegroups

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: workloads-${{ needs.determine-environment.outputs.environment }}-tfplan
          path: workloads/

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_VAR_root_resource_group_name }}" \
            -backend-config="storage_account_name=${{ vars.TF_VAR_root_storage_account_name }}" \
            -backend-config="environments/backend-${{ needs.determine-environment.outputs.environment }}.hcl"
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Apply
        run: terraform apply -auto-approve ${{ needs.determine-environment.outputs.environment }}.tfplan
        working-directory: ./workloads
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
