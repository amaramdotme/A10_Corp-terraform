name: Foundation CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'foundation/**'
      - 'modules/common/**'
      - 'modules/foundation/**'
      - '.github/workflows/foundation-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'foundation/**'
      - 'modules/common/**'
      - 'modules/foundation/**'
      - '.github/workflows/foundation-deploy.yml'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform-plan:
    name: Terraform Plan (Foundation)
    runs-on: ubuntu-latest
    # environment:
    #  name: global # adding this will gate it - manual approval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ./foundation
        continue-on-error: true

      - name: Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          hide-progress: false
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
        env:
          TRIVY_TARGET: ./foundation

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ vars.TF_VAR_root_resource_group_name }}" \
            -backend-config="storage_account_name=${{ vars.TF_VAR_root_storage_account_name }}" \
            -backend-config="environments/backend.hcl"
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Validate
        run: terraform validate
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          TF_VAR_root_resource_group_name: ${{ vars.TF_VAR_root_resource_group_name }}
          TF_VAR_root_key_vault_name: ${{ vars.TF_VAR_root_key_vault_name }}
          TF_VAR_root_storage_account_name: ${{ vars.TF_VAR_root_storage_account_name }}

      - name: Terraform Plan
        run: terraform plan -out=foundation.tfplan
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
          TF_VAR_root_resource_group_name: ${{ vars.TF_VAR_root_resource_group_name }}
          TF_VAR_root_key_vault_name: ${{ vars.TF_VAR_root_key_vault_name }}
          TF_VAR_root_storage_account_name: ${{ vars.TF_VAR_root_storage_account_name }}

      - name: Generate Human-Readable Plan
        run: terraform show -no-color foundation.tfplan > foundation-plan.txt
        working-directory: ./foundation

      - name: Upload Plan to Azure Storage (Audit Trail)
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          BLOB_NAME="plans/foundation-${TIMESTAMP}-${{ github.run_number }}.txt"
          az storage blob upload \
            --account-name ${{ vars.TF_VAR_root_storage_account_name }} \
            --container-name foundation \
            --name "$BLOB_NAME" \
            --file foundation-plan.txt \
            --auth-mode login
          echo "âœ… Plan uploaded to Azure Storage: $BLOB_NAME"
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Upload Plan Artifact (For Apply Job)
        uses: actions/upload-artifact@v4
        with:
          name: foundation-tfplan
          path: foundation/foundation.tfplan
          retention-days: 7

      - name: Generate Plan Summary for PR
        if: github.event_name == 'pull_request'
        id: plan-summary
        run: |
          # Extract summary (first 50 lines of plan)
          SUMMARY=$(terraform show -no-color foundation.tfplan | head -50)
          TOTAL_LINES=$(terraform show -no-color foundation.tfplan | wc -l)

          # Save for PR comment
          echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_OUTPUT
        working-directory: ./foundation

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PLAN_SUMMARY: ${{ steps.plan-summary.outputs.SUMMARY }}
          TOTAL_LINES: ${{ steps.plan-summary.outputs.TOTAL_LINES }}
          BLOB_PATH: plans/foundation-TIMESTAMP-${{ github.run_number }}.txt
        with:
          script: |
            const summary = process.env.PLAN_SUMMARY;
            const totalLines = process.env.TOTAL_LINES;
            const blobPath = process.env.BLOB_PATH;
            const azureStorageUrl = `https://portal.azure.com/#view/Microsoft_Azure_Storage/BlobPropertiesBladeV2/storageAccountId/%2Fsubscriptions%2F${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}%2FresourceGroups%2Frg-root-iac%2Fproviders%2FMicrosoft.Storage%2FstorageAccounts%2Fstorerootblob/path/foundation%2F${blobPath}`;

            const body = `## âœ… Foundation Terraform Plan

            **Status**: Plan generated successfully
            **Total changes**: ${totalLines} lines

            ### Plan Preview (first 50 lines)
            \`\`\`terraform
            ${summary}
            ${totalLines > 50 ? '\n... (truncated, see full plan in Azure Storage)\n' : ''}
            \`\`\`

            ### ðŸ“‹ Full Plan Available
            - **Azure Storage**: [View full plan in Azure Portal](${azureStorageUrl})
            - **Container**: \`storerootblob/foundation\`
            - **Path**: \`${blobPath}\`

            ### Next Steps
            1. Review the plan above or download from Azure Storage
            2. Approve this workflow run to proceed with apply
            3. The exact plan shown will be applied (no changes)
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

  terraform-apply:
    name: Terraform Apply (Foundation)
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: global
      url: https://portal.azure.com/#view/Microsoft_Azure_ManagementGroups/ManagementGroupBrowseBlade

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.0

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: foundation-tfplan
          path: foundation/

      - name: Terraform Init
        run: terraform init -backend-config="environments/backend.hcl"
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true

      - name: Terraform Apply
        run: terraform apply -auto-approve foundation.tfplan
        working-directory: ./foundation
        env:
          ARM_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_ROOT_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
